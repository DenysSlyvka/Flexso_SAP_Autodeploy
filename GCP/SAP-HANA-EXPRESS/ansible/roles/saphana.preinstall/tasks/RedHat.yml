---
#Installs
- name: Installing Compat-SAP-C++
  package:
    name: "{{ compat_packages }}"
    state: installed

# - name: Installing linux package repository for microsoft products
#   command: rpm -Uvh https://packages.microsoft.com/config/rhel/7/packages-microsoft-prod.rpm
#   ignore_errors: yes

- name: Installing java
  yum:
    name: java
    state: installed

#Disks
# - name: vgextend /dev/rootvg /dev/sdc
#   command: vgextend /dev/rootvg /dev/sdc
#   ignore_errors: yes

# - name: lvextend -l +100%FREE /dev/rootvg/rootlv
#   command: lvextend -l +100%FREE /dev/rootvg/rootlv
#   ignore_errors: yes

# - name: resize2fs /dev/rootvg/rootlv
#   command: resize2fs /dev/rootvg/rootlv
#   ignore_errors: yes

#Create downloads folder
- name: Create ~/Downloads directory
  file:
    path: /home/werner_deschryver/Downloads
    state: directory
    mode: '0777'
    owner: root
    group: root

#Connect to FTP server
# - name: FTP Download HXE Downloadmanager
#   get_url: 
#     url: sftp://flexsostageadmin:Flexsostageadmin2020@51.103.26.163/ftp/HXEDownloadManager_linux.bin
#     dest: /home/werner_deschryver/Downloads
#   register: get_url_result
# - debug: var=get_url_result.stdout_lines

- name: Download Bin file
  expect:
    command: sftp flexsostageadmin@51.103.26.163:/home/flexsostageadmin/ftp/HXEDownloadManager_linux.bin /home/werner_deschryver/Downloads
    responses:
      (.*)password(.*): "Flexsostageadmin2020"
      (.*)connecting(.*): "yes"

- name: Download Config file
  expect:
    command: sftp flexsostageadmin@51.103.26.163:/home/flexsostageadmin/ftp/install.rsp /home/werner_deschryver/Downloads
    responses:
      (.*)password(.*): "Flexsostageadmin2020"
      (.*)connecting(.*): "yes"

- name: Download passwords file
  expect:
    command: sftp flexsostageadmin@51.103.26.163:/home/flexsostageadmin/ftp/install.rsp.xml /home/werner_deschryver/Downloads
    responses:
      (.*)password(.*): "Flexsostageadmin2020"
      (.*)connecting(.*): "yes"


#Run HXEDownloadManager_linux.bin --ph {{ private_ip }} ...
# - name: List contents of /home/werner_deschryver/Downloads
#   command: ls /home/werner_deschryver/Downloads
#   register: contents

- name: Download hxe.tgz and hxexsa.tgz
  command: /home/werner_deschryver/Downloads/HXEDownloadManager_linux.bin --ph 10.0.2.4 --pp 8080 linuxx86_64 installer hxe.tgz hxexsa.tgz
  # when: contents.stdout == ""

#Unarchive .tars
- name: Make /HANA folder in root
  file:
    path: /HANA
    state: directory
    mode: '0777'
    owner: root
    group: root

- name: Extract hxe.tgz
  unarchive:
    src: /home/werner_deschryver/Downloads/hxe.tgz
    dest: /HANA

- name: Copy configuration an and password file into HDBLCM and run in batch mode
  shell: cat /home/werner_deschryver/Downloads/install.rsp | /HANA/HANA_EXPRESS_20/DATA_UNITS/HDB_LCM_LINUX_X86_64/hdblcm --read_password_from_stdin=xml --configfile=/home/werner_deschryver/Downloads/install.rsp -b
  ignore_errors: yes
  register: config
- debug: var=config.stdout_lines